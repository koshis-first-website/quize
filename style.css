const questionElement = document.getElementById('question');
const answerButtonsElement = document.getElementById('answer-buttons');
const nextButton = document.getElementById('next-btn');
const scoreDisplay = document.getElementById('score-display');

let score = 0;
let currentQuestionIndex = 0;
let questions = [];

// Custom Meditation Questions (Manual backup)
const meditationBackup = [
    {
        question: "What is the primary focus of Mindfulness meditation?",
        answers: [
            { text: "Thinking about the future", correct: false },
            { text: "Being present in the moment", correct: true },
            { text: "Solving math problems", correct: false },
            { text: "Sleeping deeply", correct: false }
        ]
    },
    {
        question: "Which breathing technique involves equal inhale and exhale counts?",
        answers: [
            { text: "Box Breathing", correct: true },
            { text: "Rapid Panting", correct: false },
            { text: "Holding breath for 5 minutes", correct: false },
            { text: "Mouth breathing only", correct: false }
        ]
    }
];

// Fetch Health/Nature questions from Web API
async function getZenQuestions() {
    try {
        // Category 17 is Science & Nature (closest to health/meditation)
        const response = await fetch('https://opentdb.com/api.php?amount=10&category=17&type=multiple');
        const data = await response.json();
        
        const apiQuestions = data.results.map(q => ({
            question: decodeHTML(q.question),
            answers: shuffle([
                { text: decodeHTML(q.correct_answer), correct: true },
                ...q.incorrect_answers.map(a => ({ text: decodeHTML(a), correct: false }))
            ])
        }));
        
        // Combine our custom meditation questions with the web questions
        questions = [...meditationBackup, ...apiQuestions];
        showQuestion();
    } catch (e) {
        questions = meditationBackup;
        showQuestion();
    }
}

function showQuestion() {
    resetState();
    let currentQ = questions[currentQuestionIndex];
    questionElement.innerText = currentQ.question;

    currentQ.answers.forEach(answer => {
        const button = document.createElement('button');
        button.innerText = answer.text;
        button.classList.add('btn');
        if (answer.correct) button.dataset.correct = "true";
        button.addEventListener('click', selectAnswer);
        answerButtonsElement.appendChild(button);
    });
}

function resetState() {
    nextButton.classList.add('hide');
    while (answerButtonsElement.firstChild) {
        answerButtonsElement.removeChild(answerButtonsElement.firstChild);
    }
}

function selectAnswer(e) {
    const selectedBtn = e.target;
    const isCorrect = selectedBtn.dataset.correct === "true";
    if (isCorrect) {
        selectedBtn.classList.add("correct");
        score++;
        scoreDisplay.innerText = `Score: ${score}`;
    } else {
        selectedBtn.classList.add("wrong");
    }
    
    Array.from(answerButtonsElement.children).forEach(button => {
        if (button.dataset.correct === "true") button.classList.add("correct");
        button.disabled = true;
    });
    nextButton.classList.remove('hide');
}

nextButton.addEventListener('click', () => {
    currentQuestionIndex++;
    if (currentQuestionIndex < questions.length) {
        showQuestion();
    } else {
        questionElement.innerText = `Peace attained! Your final score: ${score}/${questions.length}`;
        nextButton.innerText = "Restart Journey";
        nextButton.onclick = () => location.reload();
    }
});

function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

function decodeHTML(html) {
    const txt = document.createElement("textarea");
    txt.innerHTML = html;
    return txt.value;
}

getZenQuestions();
